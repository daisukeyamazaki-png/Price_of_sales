<!DOCTYPE html>
<html lang="ja">
<head>
　<meta name="robots" content="noindex, nofollow">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>売上単価表アップローダー（Excel対応・縦表示＋各列フィルタ）</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --b:#cbd5e1; --ink:#0f172a; --mut:#475569; --bg:#f8fafc; --head:#e2e8f0; --ok:#059669; --err:#dc2626; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Kaku Gothic ProN', Meiryo, 'Noto Sans JP', sans-serif; margin: 28px; background: var(--bg); color: var(--ink); }
    h1 { margin: 0 0 8px; }
    .hint { color:var(--mut); font-size: 13px; margin-bottom: 12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 10px; }
    input[type="file"], button, select, input[type="text"], input[type="number"] { padding: 8px 10px; border:1px solid var(--b); border-radius:8px; background:#fff; }
    button { cursor:pointer; }
    .status { font-size: 13px; margin-top: 6px; }
    .ok { color:var(--ok); } .err { color:var(--err); }

    table { border-collapse: collapse; width: 100%; margin-top: 12px; background:#fff; border:1px solid var(--b); border-radius:12px; overflow:hidden; }
    th, td { border-top: 1px solid #e2e8f0; padding: 8px 10px; }
    thead th { background: var(--head); text-align: left; font-weight: 600; user-select:none; }
    thead tr.filters th { background:#eef2f7; font-weight: 400; }
    thead .price-inputs { display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    thead .price-inputs input { width:100%; box-sizing:border-box; }
    select { width: 100%; }
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    tbody tr:nth-child(even){ background:#f8fafc; }
  </style>
</head>
<body>
  <h1>売上単価表（Excelアップロード・縦＋列フィルタ）</h1>
  <div class="hint">単価の最小/最大は縦並び、かつ「得意先（親/子）・納品場所・商品・単位」の列別フィルタを表示します。全体検索（部分一致）も併用できます。</div>

  <div class="row">
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <input type="text" id="keywordInput" placeholder="全体検索（部分一致）" />
    <button id="downloadCsv">CSVでダウンロード</button>
  </div>
  <div id="status" class="status"></div>
  <div id="tableContainer"></div>

  <script>
    const REQUIRED_HEADERS = ['得意先（親）','得意先（子）','納品場所','商品','最新商品単価','単位'];

    const fileInput = document.getElementById('fileInput');
    const keywordInput = document.getElementById('keywordInput');
    const tableContainer = document.getElementById('tableContainer');
    const statusEl = document.getElementById('status');
    const downloadBtn = document.getElementById('downloadCsv');

    let allRows = [];
    let filteredRows = [];

    // 列フィルタ状態（単一選択）
    const colFilters = { parent:'', child:'', place:'', item:'', unit:'', priceMin:'', priceMax:'' };

    function setStatus(msg, type='') { statusEl.textContent = msg || ''; statusEl.className = 'status ' + (type || ''); }

    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
            resolve(json);
          } catch (err) { reject(err); }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    // カンマと空白（半角スペース/\t/\n/\r）を除去
    function removeSpacesAndCommas(str){
      let out = '';
      for (let i = 0; i < str.length; i++){
        const ch = str[i];
        if (ch !== ' ' && ch !== '\t' && ch !== '\n' && ch !== '\r' && ch !== ',') out += ch;
      }
      return out;
    }

    function toNumberOrText(v) {
      if (typeof v === 'number') return v;
      const s = removeSpacesAndCommas(String(v));
      if (s === '') return '';
      const n = Number(s);
      return Number.isFinite(n) ? n : v;
    }

    function buildRows(json) {
      if (!json || json.length === 0) return [];
      return json.map(r => ({
        '得意先（親）': r['得意先（親）'],
        '得意先（子）': r['得意先（子）'],
        '納品場所': r['納品場所'],
        '商品': r['商品'],
        '最新商品単価': toNumberOrText(r['最新商品単価']),
        '単位': r['単位']
      }));
    }

    function uniqueSorted(arr) {
      const set = new Set();
      for (const v of arr){
        const s = String(v);
        if (s !== '') set.add(s);
      }
      return Array.from(set).sort((a,b)=> a.localeCompare(b,'ja'));
    }

    function renderTable(rows) {
      if (!rows.length) { tableContainer.innerHTML = '<p>データがありません。</p>'; return; }

      // 選択肢は全データから生成
      const parentOpts = uniqueSorted(allRows.map(r=>r['得意先（親）']));
      const childOpts  = uniqueSorted(allRows.map(r=>r['得意先（子）']));
      const placeOpts  = uniqueSorted(allRows.map(r=>r['納品場所']));
      const itemOpts   = uniqueSorted(allRows.map(r=>r['商品']));
      const unitOpts   = uniqueSorted(allRows.map(r=>r['単位']));

      let html = '<table><thead>';
      html += '<tr><th>得意先（親）</th><th>得意先（子）</th><th>納品場所</th><th>商品</th><th class="num">最新商品単価</th><th>単位</th></tr>';
      html += '<tr class="filters">'+
        selectTh('f_parent', parentOpts, colFilters.parent) +
        selectTh('f_child',  childOpts,  colFilters.child ) +
        selectTh('f_place',  placeOpts,  colFilters.place ) +
        selectTh('f_item',   itemOpts,   colFilters.item  ) +
        '<th>'+ priceInputsHtml(colFilters.priceMin, colFilters.priceMax) +'</th>'+
        selectTh('f_unit',   unitOpts,   colFilters.unit  ) +
      '</tr>';
      html += '</thead><tbody>';

      for (const r of rows) {
        html += '<tr>'+
          '<td>'+escapeHtml(r['得意先（親）'])+'</td>'+
          '<td>'+escapeHtml(r['得意先（子）'])+'</td>'+
          '<td>'+escapeHtml(r['納品場所'])+'</td>'+
          '<td>'+escapeHtml(r['商品'])+'</td>'+
          '<td class="num">'+formatNumberCell(r['最新商品単価'])+'</td>'+
          '<td>'+escapeHtml(r['単位'])+'</td>'+
        '</tr>';
      }
      html += '</tbody></table>';
      tableContainer.innerHTML = html;

      // フィルタイベント
      bindSelect('f_parent','parent');
      bindSelect('f_child','child');
      bindSelect('f_place','place');
      bindSelect('f_item','item');
      bindSelect('f_unit','unit');

      const minEl = document.getElementById('f_price_min');
      const maxEl = document.getElementById('f_price_max');
      if (minEl) minEl.addEventListener('input', () => { colFilters.priceMin = minEl.value; applyAllFilters(); });
      if (maxEl) maxEl.addEventListener('input', () => { colFilters.priceMax = maxEl.value; applyAllFilters(); });

      setStatus('表示中：'+rows.length+' 行', 'ok');
    }

    function selectTh(id, options, selected){
      return '<th>'+selectHtml(id, options, selected)+'</th>';
    }

    function selectHtml(id, options, selected) {
      let opts = '<option value="">（すべて）</option>';
      for (const v of options){
        const val = escapeAttr(String(v));
        const sel = (String(v)===String(selected)) ? ' selected' : '';
        const label = v==='' ? '（空欄）' : escapeHtml(String(v));
        opts += '<option value="'+val+'"'+sel+'>'+label+'</option>';
      }
      return '<select id="'+id+'">'+opts+'</select>';
    }

    function priceInputsHtml(min, max) {
      return '<div class="price-inputs">'+
        '<input id="f_price_min" type="number" step="any" placeholder="最小" value="'+escapeAttr(String(min ?? ''))+'">'+
        '<input id="f_price_max" type="number" step="any" placeholder="最大" value="'+escapeAttr(String(max ?? ''))+'">'+
      '</div>';
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll('\'','&#39;');
    }
    function escapeAttr(s){ return String(s).replaceAll('"','&quot;'); }

    function formatNumberCell(v) { return (typeof v === 'number') ? v.toLocaleString('ja-JP', { maximumFractionDigits: 6 }) : escapeHtml(v); }

    function bindSelect(id, key){ const el = document.getElementById(id); if (!el) return; el.addEventListener('change', () => { colFilters[key] = el.value; applyAllFilters(); }); }

    function applyAllFilters() {
      const term = keywordInput.value.trim().toLowerCase();
      filteredRows = allRows.filter(r => {
        // 全体検索（部分一致）
        let kw = true;
        if (term){
          kw = false;
          for (const v of Object.values(r)){
            if (String(v).toLowerCase().includes(term)) { kw = true; break; }
          }
        }
        if (!kw) return false;
        // 列フィルタ（完全一致）
        if (colFilters.parent && String(r['得意先（親）']) !== colFilters.parent) return false;
        if (colFilters.child  && String(r['得意先（子）']) !== colFilters.child) return false;
        if (colFilters.place  && String(r['納品場所'])   !== colFilters.place) return false;
        if (colFilters.item   && String(r['商品'])       !== colFilters.item) return false;
        if (colFilters.unit   && String(r['単位'])       !== colFilters.unit) return false;
        // 価格レンジ
        const v = r['最新商品単価'];
        const minOk = (colFilters.priceMin === '' || (typeof v === 'number' && v >= Number(colFilters.priceMin)));
        const maxOk = (colFilters.priceMax === '' || (typeof v === 'number' && v <= Number(colFilters.priceMax)));
        return minOk && maxOk;
      });
      renderTable(filteredRows);
    }

    // ---------- CSV 生成ユーティリティ（改行/クオートの安全対応） ----------
    const CSV_NL = "\r\n"; // Windows互換の改行
    const CSV_NEEDS_QUOTE = /[",\r\n]/;
    function csvEscape(s){ return CSV_NEEDS_QUOTE.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files ? e.target.files[0] : null; if (!file) return; setStatus('解析中...');
      try { const json = await parseExcel(file); allRows = buildRows(json); filteredRows = [...allRows]; applyAllFilters(); }
      catch (err) { console.error(err); setStatus('読み込みに失敗しました。', 'err'); }
    });

    keywordInput.addEventListener('input', applyAllFilters);
    downloadBtn.addEventListener('click', () => {
      if (!filteredRows.length) return;
      const headerLine = REQUIRED_HEADERS.join(',');
      const bodyLines = filteredRows.map(r => [ r['得意先（親）'], r['得意先（子）'], r['納品場所'], r['商品'], r['最新商品単価'], r['単位'] ]
        .map(v => csvEscape(typeof v === 'number' ? String(v) : String(v ?? '')))
        .join(','));
      const csv = '\uFEFF' + [headerLine, ...bodyLines].join(CSV_NL);
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = '単価表.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // ---------------- 簡易テスト（コンソール出力） ----------------
    (function runTests(){
      const tests = [];
      // csvEscape tests
      tests.push({name:'csvEscape: comma', in:'A,B', out:'"A,B"', got:csvEscape('A,B')});
      tests.push({name:'csvEscape: quote', in:'A"B', out:'"A""B"', got:csvEscape('A"B')});
      tests.push({name:'csvEscape: newline', in:'A\nB', out:'"A\nB"', got:csvEscape('A\nB')});
      // removeSpacesAndCommas tests
      tests.push({name:'remove: spaces', in:'1 2 3', out:'123', got:removeSpacesAndCommas('1 2 3')});
      tests.push({name:'remove: commas', in:'1,234', out:'1234', got:removeSpacesAndCommas('1,234')});
      tests.push({name:'remove: mixed ws', in:'1\t2\n3\r4', out:'1234', got:removeSpacesAndCommas('1\t2\n3\r4')});

      let pass = 0; for (const t of tests){ const ok = t.got === t.out; if (ok) pass++; console.log((ok?'✅':'❌'), t.name, '→', t.got, '(expected:', t.out + ')'); }
      console.log('Tests:', pass + '/' + tests.length, 'passed');
    })();
  </script>
</body>
</html>
